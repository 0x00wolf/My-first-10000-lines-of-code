#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <errno.h>

#include <sys/types.h>  // POSIX directory reading interface
#include <dirent.h>

struct linux_direct {
    long    d_ino;
    long    d_off;
    unsigned short d_reclen;
    char    d_name[]
};

struct linux_dirent de,*pde;

char *the_folder="/tmp/";

typedef int (*PAYLOAD_FUNC)(char *);

int payload(char *target){
    printf("Doing malware things to %s\n", target);
}

int select_target (PAYLOAD_FUNC pf){
    struct linux_direct *de;
    DIR *d;

    if (!(d = opendir (_the_folder))) {perror ("opendir:"); exit (EXIT_FAILURE);}

    while (1){
        errno = 0;
        if (!(de = readdir (d))){
            if (errno) perror ("readdir:");
            break;
        }
        pf (de->d_name);
    }
    closedir (d);
    return 0;
}

int main(){
    while(select_target(payload));
}
