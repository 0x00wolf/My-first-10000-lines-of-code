#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <unistd.h>

int cnt = 0;
#ifdef HAVE_CRYPTER
int mwf_decrypt_code () { puts ("Decrypt code");}
#endif

#ifdef NEEDS_PERSISTANCE
int mwf_go_persistant () { puts("Going Persistant");}
#endif

#ifdef IS_LOGIC_BOMB
int mwf_check_run_condition () {puts ("Logic Bomb: Check run conditions");return 0;}
#endif

#ifdef IS_TROJAN
int mwf_check_run_condition () {puts ("Trojan: Disgussing");}
#endif

#ifdef IS_VIRUS
int mwf_payload (char *id) { printf ("VIRUS: Doing virus stuff in %s\n", id);}
int mwf_select_target (char *id) {
    sprintf (id, "target-%03d.bin", cnt++);
    puts ("VIRUS: Selecting Target");
}
#endif

#ifdef IS_WORM
int mwf_payload (char *id) {printf ("WORM: Doing worm stuff in %s\n", id);}
int mwf_select_target (char *id) {
    sprintf (id, "target-%03d.host", cnt ++);
    printf ("WORM: Selecting Target. Please copy and run the worm in %s\n",target);
}
#endif

#ifdef IS_RANSOMWARE
int mwf_payload (char *id) { printf ("RANSOM: Crypting file %s\n", id);}
int mwf_select_target (char *id) {
    sprintf (id, "target-%03d.data", cnt++);
    puts ("RANSOM: Selecting Target");
}
#endif

#ifdef IS_SPYWARE
int mwf_payload (char *id) { puts ("SPYWARE: Waiting for command to send info");}
int mwf_select_target (char *id) {puts ("SPYWARE: Finding new data, keylogging,...");}
#endif

#ifdef IS_RAT
int mwf_payload (char *id) { printf ("RAT: Running command %s", id);}
int mwf_select_target (char *id) {printf("%s", "RAT: Waitinf for command,... $ ");fgets (id, 1024, stdin);}
#endif

int mwf_check_env () { puts("Checking environment");}

int init(){
    // Initialization
    puts ("Generic Initialization");
    // Optional: Check environment is safe
    mwf_check_env();
    // Optional: Decrypt code
#ifdef HAVE_CRYPTER
    mwf_decrypt_code ();
#endif
    // Need Persistence -> Become persistant
#ifdef NEEDS_PERSISTANCE
    mwf_go_persistant ();
#endif
    // Logic Bomb -> Check condition or exit
#ifdef IS_LOGIC_BOMB
    if (mwf_check_run_condition ()) exit (0); 
#endif
    // Trojan Horse -> Start trojan thread
#ifdef IS_TROJAN
    mwf_start_disguise_thread()
#endif
    
    return 0;
}

int payload (char *id){
    mwf_payload (id);
    // Virus            -> Inject itself + Path
    // Worm             -> Copy itself to remote machine
    // Ransomware       -> Encrypt file
    // Spyware          -> Exfiltrate data using secure channel
    // Rat/bot/backdoor -> Read command send response using secure channel
    return 0;
}

int select_target (int (*f)(char*)){
    char target[1024];
    mwf_select_target (target);

    //Infection rate to be managed here
    f (target);
    sleep (1);
    // Virus        -> Find non-infected binaries
    // Worm         -> Find suitable reachable machines
    // Ransomware   -> Find data files in disk
    // Spyware      -> Find private content in disk
    // Rat          -> Do nothing
    return 1; //Return 0 for more or 1 to end
}

int main(){
    init();
    while (select_target (payload));
}
